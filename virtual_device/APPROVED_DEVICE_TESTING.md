# Testing Approved Device Behavior

## ЁЯзк **р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ Approved Device**

### **Step 1: р╣Ар╕Хр╕гр╕╡р╕вр╕бр╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ъ**
```json
// ESP32_ENGR_LAB_001_prop.json
{
  "saved_timestamp": "2025-08-29T00:48:28.509959+00:00",
  "device_id": "ESP32_ENGR_LAB_001",
  "status": "approved",  // тЖР р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Ар╕Ыр╣Зр╕Щ approved
  "prop_data": {
    "device_id": "ESP32_ENGR_LAB_001",
    "device_name": "Computer Engineering Lab Meter",
    // ... prop data р╕нр╕╖р╣Ир╕Щр╣Ж
  },
  "submission_count": 6
}
```

### **Step 2: р╕гр╕▒р╕Щ Virtual Device**
```bash
python virtual_device_with_config_file.py
```

### **Step 3: р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╕лр╕зр╕▒р╕З**
```
ЁЯЪА р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ Virtual Device
ЁЯУ▒ Device ID: ESP32_ENGR_LAB_001
ЁЯМР MQTT Broker: iot666.ddns.net:1883
ЁЯТ╛ Config File: ESP32_ENGR_LAB_001_config.json
ЁЯУЛ Prop File: ESP32_ENGR_LAB_001_prop.json

ЁЯУВ р╣Вр╕лр╕ер╕Ф prop data р╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М: ESP32_ENGR_LAB_001_prop.json
ЁЯУК Status: approved
ЁЯУЭ Submission count: 6
ЁЯТ╛ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕бр╕╖р╣Ир╕н: 2025-08-29T00:48:28.509959+00:00
тЬЕ р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤р╣Бр╕ер╣Йр╕з - р╕Ир╕░р╕Вр╣Йр╕▓р╕б prop phase р╣Бр╕ер╕░р╕кр╣Ир╕З /data р╣Ар╕ер╕в

тЬЕ р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н MQTT р╕кр╕│р╣Ар╕гр╣Зр╕И
ЁЯУб Subscribe: devices/engineering/ESP32_ENGR_LAB_001/config
ЁЯФД р╣Ар╕гр╕┤р╣Ир╕б Data Phase (р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╕ер╕Зр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Бр╕ер╣Йр╕з)

ЁЯУК р╕кр╣Ир╕З /data: 28.5kW | 380.1V | 45.2A (14:30:45)
ЁЯУК р╕кр╣Ир╕З /data: 29.1kW | 379.8V | 46.1A (14:31:00)
```

---

## тЬЕ **р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Фр╕Вр╕╢р╣Йр╕Щ:**

### **ЁЯФД Workflow р╣Гр╕лр╕бр╣И:**
1. **р╣Вр╕лр╕ер╕Ф prop.json** тЖТ р╣Ар╕Кр╣Зр╕Др╕кр╕Цр╕▓р╕Щр╕░
2. **status = "approved"** тЖТ р╕Хр╕▒р╣Йр╕З `is_registered = True`
3. **р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н MQTT** тЖТ р╕Вр╣Йр╕▓р╕б prop phase
4. **р╣Ар╕гр╕┤р╣Ир╕б data phase** тЖТ р╕кр╣Ир╕З /data р╕Чр╕▒р╕Щр╕Чр╕╡

### **ЁЯЪл р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╣Ар╕Бр╕┤р╕Фр╕Вр╕╢р╣Йр╕Щ:**
- р╣Др╕бр╣Ир╕кр╣Ир╕З /prop р╕нр╕╡р╕Бр╣Бр╕ер╣Йр╕з
- р╣Др╕бр╣Ир╕гр╕нр╕Бр╕▓р╕гр╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤р╣Гр╕лр╕бр╣И
- р╣Др╕бр╣Ир╣Ар╕кр╕╡р╕вр╣Ар╕зр╕ер╕▓р╣Гр╕Щ prop phase

---

## ЁЯУЛ **р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:**

### **1. Log Messages:**
```
тЬЕ р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤р╣Бр╕ер╣Йр╕з - р╕Ир╕░р╕Вр╣Йр╕▓р╕б prop phase р╣Бр╕ер╕░р╕кр╣Ир╕З /data р╣Ар╕ер╕в
ЁЯФД р╣Ар╕гр╕┤р╣Ир╕б Data Phase (р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╕ер╕Зр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Бр╕ер╣Йр╕з)
```

### **2. MQTT Topics:**
- тЬЕ Subscribe: `devices/engineering/ESP32_ENGR_LAB_001/config`
- тЬЕ Publish: `devices/engineering/ESP32_ENGR_LAB_001/data`
- тЭМ р╣Др╕бр╣И Publish: `devices/engineering/ESP32_ENGR_LAB_001/prop`

### **3. Data Frequency:**
- тЬЕ р╕кр╣Ир╕З /data р╕Чр╕╕р╕Б 15 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡ (р╕Хр╕▓р╕б data_interval)
- тЭМ р╣Др╕бр╣Ир╕кр╣Ир╕З /prop р╕Чр╕╕р╕Б 30 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡

---

## ЁЯОп **Use Cases:**

### **Case 1: р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╣Гр╕лр╕бр╣И**
```
prop.json р╣Др╕бр╣Ир╕бр╕╡ тЖТ р╕кр╣Ир╕З /prop тЖТ р╕гр╕нр╕Бр╕▓р╕гр╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤
```

### **Case 2: р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╕Чр╕╡р╣И pending**
```
prop.json status="pending" тЖТ р╕кр╣Ир╕З /prop р╕Хр╣Ир╕н тЖТ р╕гр╕нр╕Бр╕▓р╕гр╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤
```

### **Case 3: р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣Мр╕Чр╕╡р╣И approved р╣Бр╕ер╣Йр╕з** тЖР **р╕Щр╕╡р╣Ир╕Др╕╖р╕нр╕Чр╕╡р╣Ир╣Ар╕гр╕▓р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г**
```
prop.json status="approved" тЖТ р╕Вр╣Йр╕▓р╕б /prop тЖТ р╕кр╣Ир╕З /data р╣Ар╕ер╕в
```

---

## ЁЯЫая╕П **р╕Бр╕▓р╕г Debug:**

### **р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Бр╕ер╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ pending:**
```json
{
  "status": "pending"  // р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Ир╕▓р╕Б approved
}
```

### **р╕ер╕Ър╣Др╕Яр╕ер╣Мр╣Ар╕Юр╕╖р╣Ир╕нр╕Чр╕Фр╕кр╕нр╕Ъ fresh start:**
```bash
del ESP32_ENGR_LAB_001_prop.json
del ESP32_ENGR_LAB_001_config.json
python virtual_device_with_config_file.py
```

---

## тЬЕ **р╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣М:**

1. **тЪб Fast Startup** - р╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М approved р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Йр╕Чр╕▒р╕Щр╕Чр╕╡
2. **ЁЯЪл No Redundant Requests** - р╣Др╕бр╣Ир╕кр╣Ир╕З prop р╕Лр╣Йр╕│
3. **ЁЯФД Smart Resume** - р╕Ир╕│р╕кр╕Цр╕▓р╕Щр╕░р╣Бр╕ер╕░р╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╣Ир╕н
4. **ЁЯТ╛ Persistent State** - р╕кр╕Цр╕▓р╕Щр╕░р╕Др╕Зр╕нр╕вр╕╣р╣Ир╣Бр╕бр╣Йр╕гр╕╡р╕кр╕Хр╕▓р╕гр╣Мр╕Ч
5. **ЁЯУК Immediate Data** - р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Яр╕Яр╣Йр╕▓р╣Др╕Фр╣Йр╕Чр╕▒р╕Щр╕Чр╕╡
